<!DOCTYPE html>
<html lang="en">
<head>
    <title>GuiLite preview</title>
</head>
<body>
    <canvas id="screen" width="1024" height="768"></canvas>
</body>

<script type="text/javascript">
function draw_single_widget(context, str, rect){
    console.log(rect.toString());
    context.fillStyle = "#FF0000";
    context.fillRect(rect[0], rect[1], rect[2], rect[3]);
    context.fillText(str, rect[0], rect[1]);
}

function draw_widgets(context, widgets){
    for( var i = 0; i < widgets.length; i++){
        widget_name = widgets[i].match(/".*"/g);
        if(widget_name.length != 1){
            console.log('Invalid widget_name' + ':' + widget_name.toString());
        }else{
            widget_name = widget_name[0].replace(/"/g,'');//remove "
        }

        widget_without_name = widgets[i].replace(/".*"/g, '');//Remove widget name for rect
        rect = widget_without_name.match(/[^A-Za-z_]\d+/g);
        console.log(widget_name.toString() + rect.toString());
        draw_single_widget(context, widget_name, rect)
    }
}

function search_widgets(tree){
    var widgets = tree.match(/{ *&[^,]*,[^,]*,[^,]*,[^,]*,[^,]*,[^,]*,[^,]*/g);
    console.log(widgets.length.toString() + ':' + widgets.toString());
    return widgets;
}

function search_trees(source){
    var trees = source.match(/WND_TREE[\s\S]*};$/mg);
    console.log(trees.length.toString() + ':' + trees.toString());
    return trees;
}

    const canvas = document.getElementById('screen');
    const context = canvas.getContext('2d');
    var source_code = `#include "core_include/api.h"
#include "core_include/rect.h"
#include "core_include/surface.h"
#include "core_include/resource.h"
#include "core_include/display.h"
#include "core_include/cmd_target.h"
#include "core_include/wnd.h"
#include "core_include/theme.h"

#include "widgets_include/label.h"
#include "widgets_include/button.h"
#include "widgets_include/spinbox.h"
#include "widgets_include/list_box.h"
#include "widgets_include/edit.h"
#include "widgets_include/dialog.h"

#include <stdio.h>

#define UI_WIDTH 680
#define UI_HEIGHT 512

enum WND_ID
{
	ID_ROOT = 1,
	ID_LABEL_1,
	ID_LABEL_2,
	ID_LABEL_3,
	ID_BUTTON,
	ID_SPIN_BOX,
	ID_LIST_BOX,
	ID_EDIT,
	ID_DIALOG,
	ID_EXIT_BUTTON
};

static c_display* s_display;
static char str[16];
class c_my_ui : public c_wnd
{
	virtual c_wnd* clone() { return new c_my_ui(); }
	virtual void on_init_children() 
	{
		c_list_box  *list_box = (c_list_box*)get_wnd_ptr(ID_LIST_BOX);
		list_box->clear_item();
		list_box->add_item((char*)"Item 0");
		list_box->add_item((char*)"Item 1");
		list_box->add_item((char*)"Item 2");
		list_box->select_item(0);

		c_spin_box  *spin_box = (c_spin_box*)get_wnd_ptr(ID_SPIN_BOX);
		spin_box->set_max_min(9, 0);
		spin_box->set_step(1);
		spin_box->set_value(5);
	}
	virtual void on_paint(void) 
	{
		m_surface->draw_rect(0, 0, UI_WIDTH - 1, UI_HEIGHT - 1, GL_RGB(0, 255, 0), Z_ORDER_LEVEL_0);
		m_surface->draw_rect(2, 2, UI_WIDTH - 3, UI_HEIGHT - 3, GL_RGB(0, 255, 0), Z_ORDER_LEVEL_0);
	};
	void on_button_clicked(unsigned int ctrl_id)
	{
		static int s_cnt;
		sprintf(str, "%d click", ++s_cnt);
		c_label* label = (c_label*)get_wnd_ptr(ID_LABEL_1);
		label->set_str(str);
		label->show_window();

		c_dialog::open_dialog((c_dialog*)get_wnd_ptr(ID_DIALOG));
	}
	void on_spinbox_confirm(unsigned int ctrl_id, int value)
	{
		sprintf(str, "choose %d", value);
		c_label* label = (c_label*)get_wnd_ptr(ID_LABEL_2);
		label->set_str(str);
		label->show_window();
	}
	void on_spinbox_change(unsigned int ctrl_id, int value)
	{
		c_label* label = (c_label*)get_wnd_ptr(ID_LABEL_2);
		label->set_str("change");
		label->show_window();
	}
	void on_listbox_confirm(unsigned int ctrl_id, int value)
	{
		sprintf(str, "choose %d", value);
		c_label* label = (c_label*)get_wnd_ptr(ID_LABEL_3);
		label->set_str(str);
		label->show_window();
	}
	GL_DECLARE_MESSAGE_MAP()//delcare message
};

GL_BEGIN_MESSAGE_MAP(c_my_ui)
ON_GL_BN_CLICKED(ID_BUTTON, c_my_ui::on_button_clicked)
ON_SPIN_CONFIRM(ID_SPIN_BOX, c_my_ui::on_spinbox_confirm)
ON_SPIN_CHANGE(ID_SPIN_BOX, c_my_ui::on_spinbox_change)
ON_LIST_CONFIRM(ID_LIST_BOX, c_my_ui::on_listbox_confirm)
GL_END_MESSAGE_MAP()

class c_my_dialog : public c_dialog
{
	virtual c_wnd* clone() { return new c_my_dialog(); }
	void on_button_clicked(unsigned int ctrl_id)
	{
		c_dialog::close_dialog(m_surface);
	}
	GL_DECLARE_MESSAGE_MAP()//delcare message
};

GL_BEGIN_MESSAGE_MAP(c_my_dialog)
ON_GL_BN_CLICKED(ID_EXIT_BUTTON, c_my_dialog::on_button_clicked)
GL_END_MESSAGE_MAP()

// Layout Widgets
static c_my_ui s_my_ui;
static c_label s_label_1, s_label_2, s_label_3;
static c_button s_button;
static c_spin_box s_spin_box;
static c_list_box s_list_box;
static c_edit s_edit;
static c_my_dialog s_my_dialog;

static c_button s_exit_button;
WND_TREE s_dialog_widgets[] =
{
	{ &s_exit_button,	ID_EXIT_BUTTON,	"Exit",	100, 100, 100, 50},
	{NULL, 0 , 0, 0, 0, 0, 0}
};

WND_TREE s_main_widgets[] =
{
	{ &s_edit,		ID_EDIT,	"Input",	275, 10, 100, 50},

	{ &s_label_1,	ID_LABEL_1,	"label 1",	150, 100, 100, 50},
	{ &s_label_2,	ID_LABEL_2,	"label 2",	150, 170, 100, 50},
	{ &s_label_3,	ID_LABEL_3,	"label 3",	150, 240, 100, 50},

	{ &s_button,	ID_BUTTON,	"Dialog",	400, 100, 100, 50},
	{ &s_spin_box,	ID_SPIN_BOX,"spinBox",	400, 170, 100, 50},
	{ &s_list_box,	ID_LIST_BOX,"listBox",	400, 240, 100, 50},

	{ &s_my_dialog,	ID_DIALOG,	"Dialog",	200, 100, 280, 312, s_dialog_widgets},
	{NULL, 0 , 0, 0, 0, 0, 0}
};

// Create GUI
extern const FONT_INFO Consolas_24B;
void load_resource()
{
	c_theme::add_font(FONT_DEFAULT, &Consolas_24B);
	//for button
	c_theme::add_color(COLOR_WND_FONT, GL_RGB(1, 184, 170));
	c_theme::add_color(COLOR_WND_NORMAL, GL_RGB(59, 75, 94));
	c_theme::add_color(COLOR_WND_PUSHED, GL_RGB(33, 42, 53));
	c_theme::add_color(COLOR_WND_FOCUS, GL_RGB(33, 42, 53));
	c_theme::add_color(COLOR_WND_BORDER, GL_RGB(46, 59, 73));
}

void create_ui(void* phy_fb, int screen_width, int screen_height, int color_bytes) {
	load_resource();

	s_display = new c_display(phy_fb, screen_width, screen_height, UI_WIDTH, UI_HEIGHT, color_bytes, 1, NULL);
	c_surface* s_surface = s_display->alloc_surface((void*)1, Z_ORDER_LEVEL_2);
	s_surface->set_active(true);

	s_my_ui.set_surface(s_surface);
	s_my_ui.connect(NULL, ID_ROOT, 0, 0, 0, UI_WIDTH, UI_HEIGHT, s_main_widgets);
	s_my_ui.show_window();

	while(1)
	{
		thread_sleep(10000);
	}
}

//////////////////////// interface for all platform ////////////////////////
void startHelloWidgets(void* phy_fb, int width, int height, int color_bytes) {
	create_ui(phy_fb, width, height, color_bytes);
}

void sendTouch2HelloWidgets(int x, int y, bool is_down)
{
	is_down ? s_my_ui.on_touch(x, y, TOUCH_DOWN) : s_my_ui.on_touch(x, y, TOUCH_UP);
}

void* getUiOfHelloWidgets(int* width, int* height, bool force_update)
{
	return s_display->get_updated_fb(width, height, force_update);
}

int captureUiOfHelloWidgets()
{
	return s_display->snap_shot("snap_short.bmp");
}`;

    var trees = search_trees(source_code);
    for( var i = 0; i < trees.length; i++){
    	var widgets = search_widgets(trees[i]);
    	draw_widgets(context, widgets);
    }
    
</script>
</html>